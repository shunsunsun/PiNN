

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Use PiNN with Ray Tune &#8212; PiNN  documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Notebooks" href="../notebooks.html" />
    <link rel="prev" title="Cloud/CLI trainer" href="pinn_train.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../notebooks.html" title="Notebooks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pinn_train.html" title="Cloud/CLI trainer"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PiNN  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../utils.html" accesskey="U">Utilities</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks.html">Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ase.html">ASE interface</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../utils.html">Utilities</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pinnboard.html">PiNNboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="pinn_train.html">Cloud/CLI trainer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Use PiNN with Ray Tune</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks.html">Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc.html">Miscellaneous Notes</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="use-pinn-with-ray-tune">
<h1>Use PiNN with Ray Tune<a class="headerlink" href="#use-pinn-with-ray-tune" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p><a class="reference external" href="https://ray.readthedocs.io/en/latest/tune.html">Tune</a> is a library for hyperparameter tuning at any scale.</p>
</div></blockquote>
<p>We have some helpers to tune the hyperparameters with the Tune library.</p>
<div class="section" id="a-working-example">
<h2>A working example<a class="headerlink" href="#a-working-example" title="Permalink to this headline">¶</a></h2>
<p>Suppose we would like to tune the hyperparameters for say, learning
rate, number of Pi blocks and the cutoff radius for a PiNet potential.
We need to first declare the space we would like to search, with Tune.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">tune</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">grid_search</span><span class="p">([</span><span class="mf">3e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">3e-5</span><span class="p">]),</span>
    <span class="s1">&#39;rc&#39;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">grid_search</span><span class="p">([</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">]),</span>
    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">grid_search</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])}</span>
</pre></div>
</div>
<p>Then we need to define a <code class="docutils literal notranslate"><span class="pre">train_fn</span></code>. Given a config it should return
several objects, a model (as an estimator), the train_spec and
eval_spec, and a reporter function which reports the metrics to Tune.</p>
<p>The reporter should take the evaluation output as input, and return a
dictionary of metrics. The naming does not matter, but note that Tune
expects a <code class="docutils literal notranslate"><span class="pre">reward_attr</span></code> which increases during training to
discriminate models, so you should define things like <code class="docutils literal notranslate"><span class="pre">accuracy</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_fn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ckpt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">yaml</span><span class="o">,</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
    <span class="kn">from</span> <span class="nn">pinn.io</span> <span class="kn">import</span> <span class="n">load_tfrecord</span>
    <span class="kn">from</span> <span class="nn">pinn.models</span> <span class="kn">import</span> <span class="n">potential_model</span>
    <span class="c1"># parameter builder</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Tune will take charge of the running path,</span>
        <span class="c1"># so model_dir can be a relative directory</span>
        <span class="s1">&#39;model_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./model_dir/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="s1">&#39;pinet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;network_params&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span>
            <span class="s1">&#39;atom_types&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]},</span>
        <span class="s1">&#39;model_params&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
            <span class="s1">&#39;en_scale&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
    <span class="c1"># disable checkpoint cleaning, and specify report frequency</span>
    <span class="c1"># note we report to Tune whenever a checkpoint is saved</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span>
        <span class="n">save_checkpoints_secs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_checkpoint_every_n_hours</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Returning things</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">potential_model</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">warm_start_from</span><span class="o">=</span><span class="n">ckpt</span><span class="p">)</span>
    <span class="n">train_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">load_tfrecord</span><span class="p">(</span><span class="s1">&#39;/path/to/train.yml&#39;</span><span class="p">)</span>
    <span class="n">test_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">load_tfrecord</span><span class="p">(</span><span class="s1">&#39;/path/to/test.yml&#39;</span><span class="p">)</span>
    <span class="n">train_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">TrainSpec</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">train_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">eval_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">EvalSpec</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">test_fn</span><span class="p">)</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">eval_out</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="o">/</span><span class="n">eval_out</span><span class="p">[</span><span class="s1">&#39;METRICS/E_MAE&#39;</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_spec</span><span class="p">,</span> <span class="n">eval_spec</span><span class="p">,</span> <span class="n">reporter</span>
</pre></div>
</div>
<p>Now you can use the TuneTrainable function to feed your <code class="docutils literal notranslate"><span class="pre">train_fn</span></code>
to Tune as a trainable.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">pinn.utils</span> <span class="kn">import</span> <span class="n">TuneTrainable</span>
<span class="c1"># Define the trainable from train_fn</span>
<span class="n">trainable</span> <span class="o">=</span> <span class="n">TuneTrainable</span><span class="p">(</span><span class="n">train_fn</span><span class="p">)</span>
<span class="c1"># Start ray cluster, use all the GPUs on this machine</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0,1,2,3,4,5&#39;</span>
<span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="c1"># Searching strategy of Ray Tune</span>
<span class="n">search_alg</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">suggest</span><span class="o">.</span><span class="n">BasicVariantGenerator</span><span class="p">(</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">schedulers</span><span class="o">.</span><span class="n">HyperBandScheduler</span><span class="p">(</span>
    <span class="n">time_attr</span><span class="o">=</span><span class="s1">&#39;time_total_s&#39;</span><span class="p">,</span> <span class="n">reward_attr</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">max_t</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="c1"># Run jobs with Ray tune</span>
<span class="n">tune</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trainable</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_tunning&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
             <span class="n">resources_per_trial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cpu&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
             <span class="n">search_alg</span><span class="o">=</span><span class="n">search_alg</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
             <span class="n">local_dir</span><span class="o">=</span><span class="s2">&quot;/tmp/test_tuning&quot;</span><span class="p">,</span>
             <span class="n">num_samples</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="visualizing-the-result">
<h2>Visualizing the result<a class="headerlink" href="#visualizing-the-result" title="Permalink to this headline">¶</a></h2>
<p>We have a <a class="reference internal" href="../notebooks/Tune_visualize.html"><span class="doc">notebook example</span></a> for visualizing tuning results from Tune.</p>
</div>
<div class="section" id="how-this-works">
<h2>How this works<a class="headerlink" href="#how-this-works" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">TuneTrainable</span></code> function is actually a general wrapper for
estimators to work with Ray Tune. It runs the train and evaluate but stops
the estimator whenever a checkpoint is saved and reports the metrics
to Tune.</p>
<p>This is a bit more elaborate than adding a reporter hook to the
estimator, and slightly slower since the training must restart from
checkpoints. But the gain is that Tune can now stop and restore
trainings when it wants, which is required by of some of Tune’s
<a class="reference external" href="https://ray.readthedocs.io/en/latest/tune-schedulers.html">schedulers</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../notebooks.html" title="Notebooks"
             >next</a> |</li>
        <li class="right" >
          <a href="pinn_train.html" title="Cloud/CLI trainer"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PiNN  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../utils.html" >Utilities</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Yunqi Shao.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>